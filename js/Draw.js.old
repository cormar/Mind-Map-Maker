mindmaps.DrawView=function(){function n(t){$(".delete-tool").click(function(){e.can.clear();e.onDrawChanged(e.can.toJSON())});$(".pencil-tool").click(function(){e.erasing=false;e.can.freeDrawingBrush.color=e.color||"000";e.can.freeDrawingBrush.width=5;$(".tool-button").removeClass("selected");$(this).addClass("selected")});$(".eraser-tool").click(function(){e.erasing=true;e.can.freeDrawingBrush.color="fff";e.can.freeDrawingBrush.width=25;$(".tool-button").removeClass("selected");$(this).addClass("selected")});$(".brush-color").colorPicker({pickerDefault:"000",colors:["000","#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"]});$(".brush-color").change(function(){currentColour=$(this).val();e.color=currentColour;if(!e.erasing)e.can.freeDrawingBrush.color=e.color||"fff"})}var e=this;var t=$("#template-draw").tmpl();this.getContent=function(){return t};this.resize=function(n,r){var i=n;var s=r-$(".ui-dialog-titlebar").height();e.can.isDrawingMode=false;e.can.calcOffset();e.can.setWidth(i);e.can.setHeight(s-50);e.can.renderAll();e.can.calcOffset();$("#canvas-panel",t).width(i).height(s-50);e.can.isDrawingMode=true};this.init=function(){e.can=new fabric.Canvas("drawingCanvas");e.can.freeDrawingBrush=new fabric["PencilBrush"](e.can);e.can.freeDrawingBrush.width=5;n(this);e.can.calcOffset();e.can.on("path:created",function(t){e.onDrawChanged(e.can.toJSON())});e.getContent().css("opacity",.8)};this.setImgData=function(t){e.can.clear();try{e.can.loadFromJSON(t)}catch(n){}}};mindmaps.DrawPresenter=function(e,t,n,r){function o(e){if(e.getPluginData("draw","imgData")){r.setImgData(e.getPluginData("draw","imgData"))}else{r.can.clear()}}var i=this;var s=null;this.saveImage=function(e){if(s){var n=new mindmaps.action.ChangeImgDataAction(s,e);t.executeAction(n)}};e.subscribe(mindmaps.Event.NODE_SELECTED,function(e){s=e;o(e)});this.go=function(){r.init();r.onDrawChanged=this.saveImage}};mindmaps.plugins["draw"]={startOrder:1e3,onUIInit:function(e,t){mindmaps.Event.PLUGIN_NODE_IMGDATA_CHANGED="NodeImgDataChangedEvent";mindmaps.action.ChangeImgDataAction=function(e,t){this.execute=function(){e.setPluginData("draw","imgData",t)};this.event=[mindmaps.Event.PLUGIN_NODE_IMGDATA_CHANGED,e]};e.subscribe(mindmaps.Event.PLUGIN_NODE_IMGDATA_CHANGED,function(e){mindmaps.ui.canvasView.updateNode(e)});var n=new mindmaps.GestureView;var r=new mindmaps.GesturePresenter(e,t,mindmaps.ui.commandRegistry,n);r.go();var i=mindmaps.ui.floatPanelFactory.create("Gesture",n.getContent());i.$widget.css("z-index","20000");var s=new mindmaps.DrawView;s.panel=u;window.drawPanel=u;var o=new mindmaps.DrawPresenter(e,t,mindmaps.ui.commandRegistry,s);var u=mindmaps.ui.floatPanelFactory.bigPanel("Draw",s.getContent(),s,function(){mindmaps.mode.inHD=true},function(){mindmaps.mode.inHD=false});o.go();mindmaps.ui.statusbarPresenter.addEntryN([u,i],"Drawing")},onCreateNode:function(e){mindmaps.util.plugins.ui.addIcon("draw",e,"edit")},onNodeUpdate:function(e,t){var n=t?"normal":"hide";if(e.getPluginData("draw","imgData")&&e.getPluginData("draw","imgData").objects&&e.getPluginData("draw","imgData").objects.length>0){n="shine"}mindmaps.util.plugins.ui.iconState("draw",e,n)}}